---
layout: post
status: publish
published: true
title: 7z文件格式及其源码的分析
author:
  display_name: Neil
  login: Neil
  email: info@byneil.com
  url: ''
author_login: Neil
author_email: info@byneil.com
wordpress_id: 79
wordpress_url: http://blog.byneil.com/?p=79
date: '2013-08-15 00:09:29 +0000'
date_gmt: '2013-08-14 16:09:29 +0000'
categories:
- 7zip
tags: []
comments: []
---
<p>本文是一个系列. 主要是分享我最近一年做7z文件开发的经验. 主要包括7z官方源码的结构分析, 以及7z文件格式的分析. 其中涉及到7z源码结构的各个细节, 以及7z文件格式的具体细节. 本文适合对象: 想要了解学习7z源码的开发人员, 想要了解7z文件格式细节, 做7z文件压缩器和解压器的开发人员, 以及其他压缩文件爱好者等等.</p>
<p>目前7z的最新稳定版是9.20, 而9.30版本还在alpha版本. 所以本文是基于其9.20版本. &nbsp;我将尽可能详细的描述所有细节, 但到目前为止我了解到的细节大概能到八成到九成的样子. 也不是百分百. &nbsp;希望能和大家共同讨论学习. &nbsp;这些信息足以开发一个工业级别的高兼容性的7z压缩器和解压器了.</p>
<p>本文首发在我的个人独立博客 &nbsp;http://byNeil.com 以及博客园. &nbsp;欢迎大家浏览我的独立博客, 留言交流. 转载请注明出处链接. 本人保留一切权利. &nbsp;但本人不对使用本文提供的代码造成的损失负责.</p>
<p>好了, 憋死我了, 前面的客套话终于说完了. &nbsp;有人可能要问, 为什么要分析7z文件格式? 这个不是开放的吗? 为什么我前面说我只了解到八,九成, 而不是百分百呢?</p>
<p>我先来解释这几个问题, 这能说明本文的必要性, 以及看下去的必要性. &nbsp;首先7z的确是开放的. 但他的格式说明非常简单, 简直是简陋. 简单的一个txt文件,寥寥几十行算不上说明的符号, 对复杂的7z格式来说, 简直就是天书.( 后面分析7z源码的时候会详细说道这一点. ) &nbsp;所以如果你接到老板的一个通知:"我们要做7z兼容的压缩解压器" 的时候, 你就要崩溃了. &nbsp;因为相对于zip这些经过标准化的文件格式来说, 7z几乎就是一个黑洞.(zip有标准化的 spec, 里面有详细到字节级别的说明). &nbsp; 所以我分析7z格式可以说有一半是通过阅读源码逆向推测出文件格式的, 再经过反复和源码对比测试证明其正确性的. &nbsp;所以我只能说了解到了八九成, 而不是百分百.</p>
<p>先分享一些有用的链接:</p>
<p>7z的官方主页:&nbsp;http://www.7-zip.org/ &nbsp;(它托管在sourceforge的虚拟机上, 本来能打开的, 但是前一段时间开始被墙了, 我实在想不到墙它的理由, 可能是被sourceforge主机上其他的网站拖累的吧,你懂的).</p>
<p>这是sourceforge上7z的论坛:&nbsp;<a href="http://sourceforge.net/p/sevenzip/discussion/45797">http://sourceforge.net/p/sevenzip/discussion/45797</a>&nbsp; . 论坛比较活跃, 每天都有新帖. 而且7z作者也在上面每天亲自回帖. &nbsp;由于作者是俄罗斯人, 所以时区跟我们差的不多. &nbsp;一般留言4个小时左右, &nbsp;作者就能回复吧. 我问过几个问题, 都是这样的. 当然也有些帖子作者懒得回, 那就另当别论了. 呵呵.</p>
<p>7z的官方中文镜像:&nbsp;http://sparanoid.com/lab/7z/ &nbsp; &nbsp;这个不需要翻墙. &nbsp;是官方给出的中文版链接. 值得信赖. 上面的内容基本和官方主页保持一致.</p>
<p>&nbsp;</p>
<p>我们先从几个概念开始吧 : &nbsp; &nbsp;7z软件 和7z文件. &nbsp; 7z文件指的是一种后缀名为.7z的文件. &nbsp; &nbsp;7z软件指的是作者开发的生成和操作7z文件的工具. &nbsp;但是现在7z软件已经发展到不光支持7z格式的文件了, 还能额外的生成和编辑另外几十种文件格式了. 其中包括我们熟知的zip格式, rar格式, iso格式等等, &nbsp;也包括一些不可思议的格式, 比如:&nbsp;CAB, CHM, CPIO, CramFS, DEB, DMG, FAT . 看眼花了吧. &nbsp;好吧, 本文主要讨论 7z文件格式, 以及7z软件中主要和7z文件相关的功能. 当然也会粗略的涉及到其他的一些有用的功能, &nbsp;比如如何给7z软件写插件, 让他支持我们自己定义的文件格式.</p>
<p>&nbsp;</p>
<p>再来几个概念. &nbsp;说到压缩文件, 一般会遇到两个概念, &nbsp; 一个是 "Compress"(压缩) 和"Archive" (存档). &nbsp; &nbsp;"存档" 这个词个人觉得不好理解. 我个人把 "Archive" 叫做 "打包".</p>
<p>举个例子, &nbsp;比如有一堆毛巾, &nbsp;每一条毛巾代表一个文件. &nbsp; &nbsp;"Compress"(压缩)的意思就是把毛巾里面的水拧干, 达到压缩的目的. &nbsp;而"Archive"(打包) 的意思就是把这些毛巾包成一个大包, 便于运输. &nbsp; &nbsp; 所以你可能想到了, 要运输一堆这样的毛巾可能有两种方法: 第一种: 先把每条毛巾拧干并折成方块(压缩), 再把这些方块组合成一个大包(打包). &nbsp;第二种, 先把这些毛巾包成一个大包(打包), &nbsp;然后再把这个大包拧干. &nbsp; &nbsp;凭经验你可能已经意识到, 前一种方法比较好处理, 而且压缩比比较大. &nbsp;后一种方法就弱一点了.</p>
<p>对了, 前一种就是先压缩后打包的方式. 7z, zip 和rar等就是用的这种方法. &nbsp; 后一种就是先打包, 后压缩的方法. 常见的tar.gz的文件就是用这种方法的. 先用tar打包, 在用gz压缩.</p>
<p>&nbsp;</p>
<p>对于7z 我们再具体解释一下 "压缩" 和 "打包" 的概念.</p>
<p>&nbsp;</p>
<p>7z 文件格式严格的说是一种"打包"的格式, &nbsp;它规定了打包的方法. &nbsp; 而"压缩"的任务是由不同的算法完成的. &nbsp; &nbsp;"压缩算法"负责把毛巾里的水拧干. 具体来讲就是把一个文件按照一定规则变小. &nbsp;压缩算法一般只能处理单个文件, 对于多个文件, 只能单个文件压缩, 然后再打包.</p>
<p>(当然,前面也说到了, 第二种方法就是先把文件打包, 然后再压缩. tar.gz就是这样的. tar工具就是简单的把所有的文件首尾相接, 变成一个大文件, 然后再用压缩算法一次压缩的. &nbsp;这个不是本文的讨论对象, 所以以后就不提了.)</p>
<p>&nbsp;</p>
<p>7z默认使用的是lzma压缩算法. &nbsp; 单个文件会先用lzma压缩算法压缩, &nbsp;然后7z负责把压缩过后的文件打包. &nbsp; (这个跟zip类似, zip文件也是打包格式, 它默认使用deflate算法压缩.) &nbsp;7z还支持封装其他几种压缩算法, 比如: Lzma2, ppmd, bzip2和deflate.</p>
<p>这些压缩算法在7z里面都有源码, &nbsp;也不是本文要讨论的重点. &nbsp;我们将重点讨论7z的打包格式. 就是介绍7z具体是怎样把压缩过后的文件封装打包的. &nbsp;期间也会夹杂介绍其中一些算法. &nbsp;后面如果有时间, 我会再单独介绍这些算法的具体实现.</p>
<p>终于把前期准备介绍完了, &nbsp; 有点繁琐.</p>
<p>下一篇我们将开始具体分析介绍7z的源码. &nbsp; &nbsp;完成之后, 我会把第二篇的链接更新到这里. 当然你也可以在我的博客中搜索到.</p>
<p>大家多多支持哦.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
